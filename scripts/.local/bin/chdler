#!/usr/bin/env bash
#
# download 4chan thread medias

IFS=/ read -r _ _ host query <<< $1

[[ $host && $query ]] || {
    echo "usage : ${0##*/} [thread]" >&2
    exit 1
}

trap 'exec 3<&-' EXIT

exec 3< "/dev/tcp/$host/80"

{
    echo "GET /$query HTTP/1.1"
    echo "connection: close"
    echo "host: $host"
    echo
} >&3

declare -A array

while read -rd \< line; do
    [[ $line =~ ('//is2.4chan.org/'[^\"]+) ]] &&
        array[${BASH_REMATCH[1]}]=1
done <&3

for file in "${!array[@]}"; {
    wget "https:$file" &> /dev/null &&
        echo "'${file##*/}' downloaded"
}
